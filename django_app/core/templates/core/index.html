{% extends "core/base.html" %}
{% block title %}SVDash — Upload{% endblock %}

{% block content %}
<div class="hero">
    <h1 class="hero-title">Image Decomposition<br><span class="hero-accent">Analysis Engine</span></h1>
    <p class="hero-sub">Upload an image to perform SVD/PCA decomposition. Analyze singular values, reconstruct at variable rank, and measure quality metrics.</p>

    <div class="server-status">
        <span class="status-dot {% if server_ok %}status-ok{% else %}status-err{% endif %}"></span>
        <span class="status-text">Compute server: {% if server_ok %}online (MPS){% else %}offline{% endif %}</span>
    </div>
</div>

<div class="upload-section">
    <form method="post" action="{% url 'upload' %}" enctype="multipart/form-data" class="upload-form" id="upload-form">
        {% csrf_token %}

        <div class="form-group">
            <label class="form-label" for="id_title">Analysis Name</label>
            {{ form.title }}
        </div>

        <div class="drop-zone" id="drop-zone">
            <div class="drop-zone-inner">
                <div class="drop-icon">&#x2B21;</div>
                <p class="drop-text">Drop image here or <label for="id_image" class="drop-browse">browse</label></p>
                <p class="drop-hint">JPG, PNG — any resolution</p>
                {{ form.image }}
            </div>
            <div class="drop-preview" id="drop-preview" style="display:none;">
                <img id="preview-img" src="" alt="Preview">
                <span class="preview-name" id="preview-name"></span>
            </div>
        </div>

        <div class="form-group form-group-inline">
            <label class="form-checkbox-label">
                {{ form.grayscale }}
                <span class="checkbox-text">Grayscale mode <span class="checkbox-hint">(single-channel luminance)</span></span>
            </label>
        </div>

        <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
            <span class="btn-icon">&#x25B8;</span>
            Decompose
        </button>
    </form>
</div>

<!-- Progress overlay -->
<div class="progress-overlay" id="progress-overlay">
    <div class="progress-panel">
        <div class="progress-icon"><span class="spinner">&#x25CC;</span></div>
        <div class="progress-status" id="progress-status">Uploading image...</div>
        <div class="progress-bar-track">
            <div class="progress-bar-fill" id="progress-fill"></div>
        </div>
        <div class="progress-detail" id="progress-detail">Sending to compute server</div>
    </div>
</div>

{% if recent %}
<div class="recent-section">
    <h2 class="section-title">Recent Analyses</h2>
    <div class="recent-grid">
        {% for a in recent %}
        <a href="{% url 'analysis' pk=a.pk %}" class="recent-card">
            <div class="recent-thumb">
                <img src="{{ a.image.url }}" alt="{{ a.title }}">
            </div>
            <div class="recent-info">
                <span class="recent-name">{{ a }}</span>
                <span class="recent-meta">{{ a.width }}x{{ a.height }} | k95={{ a.k_95 }} | SSIM={{ a.ssim }}</span>
            </div>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('id_image');
const preview = document.getElementById('drop-preview');
const previewImg = document.getElementById('preview-img');
const previewName = document.getElementById('preview-name');
const submitBtn = document.getElementById('submit-btn');
const dropInner = dropZone.querySelector('.drop-zone-inner');

function showPreview(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewName.textContent = file.name + ' (' + (file.size / 1024 / 1024).toFixed(1) + ' MB)';
        dropInner.style.display = 'none';
        preview.style.display = 'flex';
        submitBtn.disabled = false;
    };
    reader.readAsDataURL(file);
}

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length) showPreview(e.target.files[0]);
});

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('drag-over');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length) {
        fileInput.files = files;
        showPreview(files[0]);
    }
});

// ─── Progress bar + AJAX upload ─────────────────────────────────────────
const overlay = document.getElementById('progress-overlay');
const statusEl = document.getElementById('progress-status');
const fillEl = document.getElementById('progress-fill');
const detailEl = document.getElementById('progress-detail');

const stages = [
    { text: 'Uploading image...', detail: 'Sending file to server', pct: 10, delay: 0 },
    { text: 'Computing SVD...', detail: 'Decomposing on MPS device', pct: 35, delay: 1500 },
    { text: 'Analyzing components...', detail: 'Computing singular values & variance', pct: 55, delay: 4000 },
    { text: 'Generating matrices...', detail: 'Rendering U, S, Vt heatmaps', pct: 75, delay: 7000 },
    { text: 'Finalizing...', detail: 'Saving results to disk', pct: 90, delay: 12000 },
];

let stageTimers = [];

document.getElementById('upload-form').addEventListener('submit', (e) => {
    e.preventDefault();

    // Show overlay
    overlay.classList.add('visible');
    submitBtn.disabled = true;

    // Animate stages
    stageTimers = stages.map(stage =>
        setTimeout(() => {
            statusEl.textContent = stage.text;
            detailEl.textContent = stage.detail;
            fillEl.style.width = stage.pct + '%';
        }, stage.delay)
    );

    // Submit via fetch
    const formData = new FormData(e.target);
    fetch(e.target.action, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
    })
    .then(r => r.json())
    .then(data => {
        stageTimers.forEach(clearTimeout);
        if (data.redirect) {
            fillEl.style.width = '100%';
            statusEl.textContent = 'Analysis complete';
            detailEl.textContent = 'Redirecting to results...';
            setTimeout(() => { window.location.href = data.redirect; }, 400);
        } else if (data.error) {
            overlay.classList.remove('visible');
            submitBtn.disabled = false;
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        stageTimers.forEach(clearTimeout);
        overlay.classList.remove('visible');
        submitBtn.disabled = false;
        alert('Connection error: ' + err.message);
    });
});
</script>
{% endblock %}
