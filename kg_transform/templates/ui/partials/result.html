<div class="flex flex-col gap-4 animate-fade-in">
    <!-- Metadata Banner -->
    <div
        class="bg-slate-800 rounded p-3 text-xs flex justify-between items-center shadow-lg border-l-4 border-indigo-500">
        <div class="flex gap-4">
            <span><i class="fa-solid fa-robot text-slate-400 mr-1"></i> {{ metadata.model|default:"Default" }}</span>
            <span><i class="fa-solid fa-coins text-slate-400 mr-1"></i> In: {{ metadata.prompt_tokens }} / Out: {{
                metadata.completion_tokens }}</span>
        </div>
        <div class="text-slate-400">
            ID: <span class="font-mono text-indigo-300">{{ transformation_id }}</span>
        </div>
    </div>

    <!-- Vis.js Graph Container -->
    <div class="flex flex-col gap-1 h-[400px]">
        <label class="text-xs font-bold text-slate-400 uppercase">Graph Visualization (Output)</label>
        <div id="vis-network-container"
            class="bg-slate-800 border border-slate-700 rounded h-full shadow-inner relative">
            <div class="absolute top-2 right-2 bg-slate-900/80 p-2 rounded text-xs z-10">
                <span class="text-green-400"><i class="fa-solid fa-circle"></i> Output Nodes</span>
            </div>
        </div>
    </div>

    <!-- Diff Operations -->
    <div class="flex flex-col gap-2">
        <label class="text-xs font-bold text-slate-400 uppercase">Atomic Operations</label>
        <div class="flex flex-col gap-2 max-h-[300px] overflow-y-auto pr-2">
            {% for op in diff %}
            <div class="p-3 rounded border-l-4 shadow-sm text-sm font-mono flex items-start gap-3
                {% if op.op_type == 'ADD_NODE' or op.op_type == 'ADD_EDGE' %} bg-green-900/20 border-green-500 text-green-100
                {% elif op.op_type == 'REMOVE_NODE' or op.op_type == 'REMOVE_EDGE' %} bg-red-900/20 border-red-500 text-red-100
                {% else %} bg-yellow-900/20 border-yellow-500 text-yellow-100 {% endif %}">

                <div class="mt-0.5">
                    {% if op.op_type == 'ADD_NODE' or op.op_type == 'ADD_EDGE' %} <i
                        class="fa-solid fa-plus-circle text-green-500"></i>
                    {% elif op.op_type == 'REMOVE_NODE' or op.op_type == 'REMOVE_EDGE' %} <i
                        class="fa-solid fa-minus-circle text-red-500"></i>
                    {% else %} <i class="fa-solid fa-pen-to-square text-yellow-500"></i> {% endif %}
                </div>

                <div class="flex-grow break-all">
                    <span class="font-bold opacity-75 mr-2">{{ op.op_type }}</span>
                    <span class="text-xs bg-black/30 px-1 py-0.5 rounded">{{ op.target_id }}</span>

                    {% if op.payload %}
                    <div class="mt-1 text-xs opacity-70 bg-black/20 p-1 rounded whitespace-pre-wrap">{{ op.payload|pprint }}</div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="text-center text-slate-500 py-4 italic">No changes detected.</div>
            {% endfor %}
        </div>
    </div>

    <!-- Output JSON -->
    <div class="flex flex-col gap-1 h-[300px]">
        <label class="text-xs font-bold text-slate-400 uppercase">Output Knowledge Graph</label>
        <div class="border border-slate-700 rounded overflow-hidden flex-grow relative">
            <textarea id="kg-output"></textarea>
        </div>
    </div>
</div>

<script>
    // Initialize Output CodeMirror and Vis.js
    (function () {
        // CodeMirror for output
        const outputArea = document.getElementById("kg-output");
        const kgData = {{ kg_output_json| safe
    }};

    if (outputArea) {
        const editorOut = CodeMirror.fromTextArea(outputArea, {
            mode: "application/ld+json",
            theme: "dracula",
            readOnly: true,
            lineNumbers: true,
            lineWrapping: true
        });
        editorOut.setValue(JSON.stringify(kgData, null, 2));
    }

    // Initialize Vis.js
    const container = document.getElementById('vis-network-container');
    const nodes = new vis.DataSet([]);
    const edges = new vis.DataSet([]);

    if (kgData && kgData['@graph']) {
        kgData['@graph'].forEach(function (item) {
            // Node
            if (item['@id']) {
                let label = item.name || item['@id'];
                let group = item['@type'];
                if (Array.isArray(group)) group = group[0];

                nodes.add({
                    id: item['@id'],
                    label: label,
                    group: group,
                    color: { background: '#10b981', border: '#059669' },
                    font: { color: '#ffffff' }
                });
            }
        });

        // Edges (2nd pass)
        kgData['@graph'].forEach(function (item) {
            Object.keys(item).forEach(function (key) {
                if (key.startsWith('@')) return;
                let val = item[key];
                if (Array.isArray(val)) {
                    val.forEach(function (v) {
                        if (v && v['@id']) {
                            edges.add({ from: item['@id'], to: v['@id'], label: key, arrows: 'to', color: { color: '#64748b' } });
                        }
                    });
                } else if (val && typeof val === 'object' && val['@id']) {
                    edges.add({ from: item['@id'], to: val['@id'], label: key, arrows: 'to', color: { color: '#64748b' } });
                }
            });
        });
    }

    const data = { nodes: nodes, edges: edges };
    const options = {
        layout: { randomSeed: 2 },
        physics: { enabled: true, solver: 'forceAtlas2Based' }
    };
    new vis.Network(container, data, options);
    }) ();
</script>